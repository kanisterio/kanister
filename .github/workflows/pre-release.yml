name: Pre release
run-name: Pre-release ${{ inputs.release_tag }}

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Image tag in the format x.x.x'
        required: true
        type: string

env:
  RELEASE_TAG: ${{ inputs.release_tag }}
  PRERELEASE_DOCS_BRANCH: 'dg8d45z'

jobs:
  bump_release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - name: kanister
            repository: kanisterio/kanister
            branch_prefix: kan-docs
          - name: blueprints
            repository: kanisterio/blueprints
            branch_prefix: blueprints-pre-release

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ matrix.repo.repository }}
          token: ${{ secrets.KANISTER_BOT_GH_TOKEN }}
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch tags
        run: git fetch --tags origin

      - name: Detect current tag
        id: current_tag
        run: |
          CURRENT_TAG=$(git describe --abbrev=0 --tags)
          echo "current_tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT

      - name: Bump version
        run: |
          ./build/bump_version.sh \
            "${{ steps.current_tag.outputs.current_tag }}" \
            "${RELEASE_TAG}"

      - name: reno report
        if: matrix.repo.name == 'kanister'
        run: make reno-report VERSION="${RELEASE_TAG}"

      - name: Commit changes
        run: |
          git config --global user.name 'Kasten Production'
          git config --global user.email 'infra@kasten.io'

          BRANCH_NAME="${{ matrix.repo.branch_prefix }}-${PRERELEASE_DOCS_BRANCH}-${RELEASE_TAG}"

          git checkout -B "${BRANCH_NAME}"
          git add -A
          git commit -s -m "pre-release: Update version to ${RELEASE_TAG}" || echo "No changes to commit"

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_ENV

      - name: Push branch
        run: |
          git push origin "${branch_name}" --force

      - name: Generate PR body (kanister only)
        if: matrix.repo.name == 'kanister'
        run: |
          echo "Update version to ${RELEASE_TAG}" > PR_BODY_FILE
          echo "" >> PR_BODY_FILE
          echo "Please check the changelog for the following merges:" >> PR_BODY_FILE

          git log \
            ${{ steps.current_tag.outputs.current_tag }}..${branch_name} \
            --pretty="- %h: %s" \
            | grep -v ': test' \
            | grep -v ': doc' \
            | grep -v ': build' \
            | grep -v ': deps' \
            >> PR_BODY_FILE

      - name: Create PR
        run: |
          if [ "${{ matrix.repo.name }}" = "kanister" ]; then
            gh pr create \
              --title "pre-release: Update version to ${RELEASE_TAG}" \
              -F PR_BODY_FILE \
              --head "${branch_name}" \
              --base master \
              --reviewer pavannd1,viveksinghggits,hairyhum \
              --label kueue
          else
            gh pr create \
              --title "pre-release: Update version to ${RELEASE_TAG}" \
              --body "Automated version bump to ${RELEASE_TAG}" \
              --head "${branch_name}" \
              --base master
          fi
        env:
          GH_TOKEN: ${{ secrets.KANISTER_BOT_GH_TOKEN }}

