name: Pre release
run-name: Pre-release ${{ inputs.release_tag }}

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Image tag in the format x.x.x'
        required: true
        type: string

env:
  RELEASE_TAG: ${{ inputs.release_tag }}
  PRERELEASE_DOCS_BRANCH: 'dg8d45z'

jobs:

  ############################################################
  # 1️⃣ Bump version in kanister repository
  ############################################################
  bump_kanister:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    outputs:
      current_tag: ${{ steps.get_tag.outputs.current_tag }}

    steps:
      - name: checkout_repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: Get current tag
        id: get_tag
        run: |
          CURRENT_TAG=$(git describe --abbrev=0 --tags)
          echo "current_tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT
          echo "Current tag: ${CURRENT_TAG}"

      - name: Bump version
        run: |
          ./build/bump_version.sh "${{ steps.get_tag.outputs.current_tag }}" "${RELEASE_TAG}"
          make reno-report VERSION="${RELEASE_TAG}"

      - name: Commit changes
        run: |
          git config --global user.name 'Kasten Production'
          git config --global user.email 'infra@kasten.io'
          git checkout -B "kan-pre-release-${RELEASE_TAG}"
          git add -A
          git commit -s -m "pre-release: Update version to ${RELEASE_TAG}" || echo "No changes to commit"

      - name: Push branch
        run: |
          git push origin "kan-pre-release-${RELEASE_TAG}" --force

      - name: create_pr_body
        run: |
          echo "Update version to ${RELEASE_TAG}" > PR_BODY_FILE
          echo "" >> PR_BODY_FILE
          echo "Please check the changelog for the following merges:" >> PR_BODY_FILE
          export CURRENT_TAG=$(git describe --abbrev=0 --tags)
          git log ${CURRENT_TAG}..kan-docs-${PRERELEASE_DOCS_BRANCH}-${RELEASE_TAG} --pretty="- %h: %s"  | grep -v ': test' | grep -v ': doc' | grep -v ': build' | grep -v ': deps'  >> PR_BODY_FILE

      - name: Create PR
        run: |
          gh pr create \
            --title "pre-release: Update version to ${RELEASE_TAG}" \
            -F PR_BODY_FILE \
            --head "kan-docs-${PRERELEASE_DOCS_BRANCH}-${RELEASE_TAG}" \
            --reviewer pavannd1,viveksinghggits,hairyhum \
            --base master \
            --label kueue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ############################################################
  # 2️⃣ Bump version in blueprints repository
  ############################################################
  bump_blueprints:
    runs-on: ubuntu-latest
    needs: bump_kanister
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout blueprints repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: kanisterio/blueprints
          token: ${{ secrets.KANISTER_BOT_GH_TOKEN }}
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags origin

      - name: Bump version in blueprints
        run: |
          ./bump_version.sh "${{ needs.bump_kanister.outputs.current_tag }}" "${RELEASE_TAG}"

      - name: Commit changes
        run: |
          git config --global user.name 'Kasten Production'
          git config --global user.email 'infra@kasten.io'
          git checkout -B "blueprints-pre-release-${RELEASE_TAG}"
          git add -A
          git commit -s -m "pre-release: Update version to ${RELEASE_TAG}" || echo "No changes to commit"

      - name: Push branch
        run: |
          git push origin "blueprints-pre-release-${RELEASE_TAG}" --force

      - name: Create PR
        run: |
          gh pr create \
            --title "pre-release: Update version to ${RELEASE_TAG}" \
            --body "Automated version bump to ${RELEASE_TAG}" \
            --head "blueprints-pre-release-${RELEASE_TAG}" \
            --base master
        env:
          GH_TOKEN: ${{ secrets.KANISTER_BOT_GH_TOKEN }}
