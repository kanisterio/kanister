name: Build and test
permissions:
  contents: read
on:
  push:
    branches:
    - master
  pull_request:

jobs:
  ## Make sure go.mod and go.sum files are up-to-date with the code
  ## TODO: make this fail if they're not up-to-date to inform the committer to udpate them
  gomod:
    runs-on: ubuntu-24.04
    outputs:
      gomod: ${{ steps.gomod.outputs.gomod }}
      gosum: ${{ steps.gosum.outputs.gosum }}
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    - run: make go-mod-tidy
    - id: gomod
      run: |
        {
          echo 'gomod<<FILE'
          cat go.mod
          echo
          echo FILE
        } >> "$GITHUB_OUTPUT"
    - id: gosum
      run: |
        {
          echo 'gosum<<FILE'
          cat go.sum
          echo
          echo FILE
        } >> "$GITHUB_OUTPUT"
  lint:
    runs-on: ubuntu-24.04
    needs: gomod
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    ## Sync go.mod and go.sum files from gomod job
    - name: restore_gomod
      run: echo "${{needs.gomod.outputs.gomod}}" > go.mod
    - name: restore_gosum
      run: echo "${{needs.gomod.outputs.gosum}}" > go.sum
    - run: make golint

  reno_lint:
    runs-on: ubuntu-24.04
    needs: gomod
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        fetch-depth: 0
    # - name: reset_git_extension
    #   run: git config --unset-all extensions.worktreeconfig
    - name: reno_lint
      run: make reno-lint
    ## Reno lint does not catch some errors which make reno report fail
    - name: reno_report_check
      run: make reno-report

  # Builds a Kanister tools container image from the current pull request commit.
  # The image is tagged using the PR commit SHA and pushed to GHCR so that
  # integration tests can consume the exact code under review.
  build_test_tools_image:
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: kanisterio/test_tools_image
    runs-on: ubuntu-24.04
    needs: [image_tags, gomod]
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      - name: Image metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=raw,value=integration-test
            {{date 'YYYY.MM.DD-HHmm'}}
            ${{ needs.image_tags.outputs.tag_short }}
            ${{ needs.image_tags.outputs.tag_long }}
      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Tools & Copy to Context
        run: |
          make build BIN=kanctl
          make build BIN=kando
          mkdir -p docker/tools
          cp kanctl docker/tools/kanctl
          cp kando  docker/tools/kando
          cp LICENSE docker/tools/LICENSE
          chmod +x docker/tools/kanctl docker/tools/kando
      - name: Build and push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: "docker/tools"
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Deletes the Kanister tools Docker image created for this pull request
  # from GitHub Container Registry (GHCR) after integration tests complete.
  cleanup_test_tools_image:
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-24.04
    needs: [ test ]
    if: always()
    steps:
      - name: Delete PR tools image using GitHub API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: kanisterio
          PACKAGE_NAME: test_tools_image
        run: |
          set -euo pipefail
          echo "Fetching package versions..."
          VERSION_IDS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions \
            --paginate \
            --jq '.[].id')
          if [[ -z "${VERSION_IDS}" ]]; then
            echo "No package versions found. Nothing to delete."
            exit 0
          fi
          for ID in ${VERSION_IDS}; do
            echo "Deleting package version ID=${ID}"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              /orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${ID} \
              || echo "Skipping protected version ${ID}"
          done
          echo "Cleanup completed."
  test:
    runs-on: ubuntu-24.04
    needs: [gomod, build_test_tools_image]
    strategy:
      fail-fast: false
      matrix:
        testSuite: [test, integration-test, helm-test]
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    ## Sync go.mod and go.sum files from gomod job
    - name: restore_gomod
      run: echo "${{needs.gomod.outputs.gomod}}" > go.mod
    - name: restore_gosum
      run: echo "${{needs.gomod.outputs.gosum}}" > go.sum
    - uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0
    # A test (CRDSuite) that runs as part of `make test` requies atleast one CRD to
    # be present on the cluster. That's why we are only installing csi-hostpath-driver
    # before running `make test`, to create some CRDs on the cluster.
    - run: |
        make install-csi-hostpath-driver
        make install-minio
    - run: |
        export POD_NAME=$(kubectl get pods --namespace minio -l "release=minio" -o jsonpath="{.items[0].metadata.name}")
        nohup kubectl port-forward $POD_NAME 9000 --namespace minio &
        sleep 5
      if: matrix.testSuite == 'test'
    ## We set LOCAL_MINIO to avoid issues with DNS in github action runniers
    - run: make ${{ matrix.testSuite }} LOCAL_MINIO=true
  build:
    runs-on: ubuntu-24.04
    needs: gomod
    strategy:
      matrix:
        bin: [controller, kanctl, kando]
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    ## Sync go.mod and go.sum files from gomod job
    - name: restore_gomod
      run: echo "${{needs.gomod.outputs.gomod}}" > go.mod
    - name: restore_gosum
      run: echo "${{needs.gomod.outputs.gosum}}" > go.sum
    - run: make build BIN=${{ matrix.bin }}
  docs:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    - run: make docs
  release:
    runs-on: ubuntu-24.04
    needs: [lint, test, build, docs]
    if: github.ref_name == 'master' || startsWith(github.ref, 'refs/tags')
    permissions:
      packages: write
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    - run: make go-mod-tidy
    - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - run: sudo rm -rf /usr/share/dotnet
    - run: sudo rm -rf "$AGENT_TOOLSDIRECTORY"
    - run: docker image prune -af
    - run: docker builder prune -af
    - run: make release-snapshot
    - run: COMMIT_SHA=${{ github.sha }} ./build/push_images.sh
  image_tags:
    runs-on: ubuntu-latest
    outputs:
      tag_short: ${{ steps.image_tags.outputs.tag_short }}
      tag_long: ${{ steps.image_tags.outputs.tag_long }}
    steps:
    - id: image_tags
      env:
        COMMIT_SHA: ${{ github.sha }}
      run: |
        echo "tag_short=short-commit-${COMMIT_SHA::12}" >> $GITHUB_OUTPUT
        echo "tag_long=commit-${COMMIT_SHA}" >> $GITHUB_OUTPUT
  release_example_docker_images:
    needs: [release, image_tags]
    permissions:
      packages: write
      contents: read
    uses: ./.github/workflows/build_example_images.yaml
    with:
      image_tag: v9.99.9-dev
      ref: ${{ github.ref }}
      platforms: linux/amd64
      extra_tags: |
        ${{ needs.image_tags.outputs.tag_short }}
        ${{ needs.image_tags.outputs.tag_long }}

