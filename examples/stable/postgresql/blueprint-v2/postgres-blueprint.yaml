apiVersion: cr.kanister.io/v1alpha1
kind: Blueprint
metadata:
  name: postgres-bp
dataMover: kopia
actions:
  backup:
    kind: StatefulSet
    outputArtifacts:
      pgBackup:
        keyValue:
          backupPath: "{{ .Phases.pgDump.Output.backupPath }}"
          backupID: "{{ .Phases.pgDump.Output.backupID }}"
    phases:
    - func: KubeTask
      name: pgDump
      objects:
        pgSecret:
          kind: Secret
          name: '{{ index .Object.metadata.labels "app.kubernetes.io/instance" }}-postgresql'
          namespace: '{{ .StatefulSet.Namespace }}'
      args:
        image: ghcr.io/kanisterio/postgres-kanister-tools:0.53.0
        namespace: '{{ .StatefulSet.Namespace }}'
        command:
        - bash
        - -o
        - errexit
        - -o
        - pipefail
        - -c
        - |
          export PGHOST='{{ index .Object.metadata.labels "app.kubernetes.io/instance" }}-postgresql.{{ .StatefulSet.Namespace }}.svc.cluster.local'
          export PGUSER='postgres'
          export PGPASSWORD='{{ index .Phases.pgDump.Secrets.pgSecret.Data "postgresql-password" | toString }}'
          backup_path=pg_backups/{{ .StatefulSet.Namespace }}/{{ .StatefulSet.Name }}/{{ toDate "2006-01-02T15:04:05.999999999Z07:00" .Time | date "2006-01-02T15:04:05Z07:00" }}/backup.sql.gz
          pg_dumpall --clean -U $PGUSER | gzip -c | kando location push --profile '{{ toJson .Profile }}' --path "${backup_path}" -
          kando output backupPath "${backup_path}"
  restore:
    kind: StatefulSet
    inputArtifactNames:
    - pgBackup
    phases:
    - func: KubeTask
      name: pgRestore
      objects:
        pgSecret:
          kind: Secret
          name: '{{ index .Object.metadata.labels "app.kubernetes.io/instance" }}-postgresql'
          namespace: '{{ .StatefulSet.Namespace }}'
      args:
        image: ghcr.io/kanisterio/postgres-kanister-tools:0.53.0
        namespace: '{{ .StatefulSet.Namespace }}'
        command:
        - bash
        - -o
        - errexit
        - -o
        - pipefail
        - -c
        - |
          export PGHOST='{{ index .Object.metadata.labels "app.kubernetes.io/instance" }}-postgresql.{{ .StatefulSet.Namespace }}.svc.cluster.local'
          export PGUSER='postgres'
          export PGPASSWORD='{{ index .Phases.pgRestore.Secrets.pgSecret.Data "postgresql-password" | toString }}'
          backup_path={{ .ArtifactsIn.pgBackup.KeyValue.backupPath }}
          backup_id={{ .ArtifactsIn.pgBackup.KeyValue.backupID }}
          kando location pull --profile '{{ toJson .Profile }}' --path "${backup_path}" --backupID ${backup_id} - | gunzip -c -f | psql -q -U "${PGUSER}"
  delete:
    type: Namespace
    inputArtifactNames:
      - pgBackup
    phases:
    - func: KubeTask
      name: deleteDump
      args:
        image: ghcr.io/kanisterio/postgres-kanister-tools:0.53.0
        namespace: "{{ .Namespace.Name }}"
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            backup_path='{{ .ArtifactsIn.pgBackup.KeyValue.backupPath }}'
            backup_id='{{ .ArtifactsIn.pgBackup.KeyValue.backupID }}'
            kando location delete --profile '{{ toJson .Profile }}' --path "${backup_path}" --backupID ${backup_id}
