apiVersion: cr.kanister.io/v1alpha1
kind: Blueprint
metadata:
  name: foundationdb-blueprint
actions:
  backup:
    kind: CustomResource
    outputArtifacts:
      fdbBackup:
        keyValue:
          path: ''
    phases:
    - func: KubeExec
      name: TakeBackup
      args:
        namespace: "{{ .Object.metadata.namespace }}"
        pod: "foundationdbcluster-sample-1"
        container: foundationdb
        command:
          - bash
          - -o
          - pipefail
          - -o
          - errexit
          - -c
          - |
            /usr/bin/backup_agent -C /var/dynamic-conf/fdb.cluster  &
            mkdir -p /data/fdbbackup
            chmod -R 777 /data/fdbbackup
            fdbbackup start  -d file:///data/fdbbackup
            sleep 180
            pkill -9 backup_agent
  restore:
    kind: CustomResource
    inputArtifactNames:
    - fdbBackup
    phases:
    - func: KubeExec
      name: restoreBackup
      args:
        namespace: "{{ .Object.metadata.namespace }}"
        pod: "foundationdbcluster-sample-1"
        container: foundationdb
        command:
          - bash
          - -o
          - pipefail
          - -o
          - errexit
          - -c
          - |
            backupname=$(ls /data/fdbbackup/)
            fdbrestore start --dest_cluster_file /var/dynamic-conf/fdb.cluster -r file:///data/fdbbackup/$backupname
  