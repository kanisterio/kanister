apiVersion: cr.kanister.io/v1alpha1
kind: Blueprint
metadata:
  name: mongodb-atlas-blueprint
actions:
  backup:
    outputArtifacts:
      backupOutput:
        keyValue:
          snapshotId: "{{ .Phases.mongoBackup.Output.snapshotId }}"
    phases:
    - func: KubeTask
      name: mongoBackup
      args:
        namespace: "{{ .Object.metadata.namespace }}"
        image: <registry>/<repository>/mongodb-atlas:<tag_name>
        podOverride:
          containers:
          - name: container
            env:
            - name: MONGODB_ATLAS_PUBLIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: publickey
            - name: MONGODB_ATLAS_PRIVATE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: privatekey
            - name: MONGODB_ATLAS_ORG_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: orgid
            - name: MONGODB_ATLAS_PROJECT_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: projectid
            - name: MONGODB_ATLAS_CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: clustername
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            atlas backups snapshots create ${MONGODB_ATLAS_CLUSTER_NAME} --desc "MongoDB Atlas snapshot" -o json > output.json
            snapshot_id=$(jq -r ".id" output.json)
            kando output snapshotId ${snapshot_id}

    - func: KubeTask
      name: waitForBackupToComplete
      args:
        namespace: "{{ .Object.metadata.namespace }}"
        image: <registry>/<repository>/mongodb-atlas:<tag_name>
        podOverride:
          containers:
          - name: container
            env:
            - name: MONGODB_ATLAS_PUBLIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: publickey
            - name: MONGODB_ATLAS_PRIVATE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: privatekey
            - name: MONGODB_ATLAS_ORG_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: orgid
            - name: MONGODB_ATLAS_PROJECT_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: projectid
            - name: MONGODB_ATLAS_CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: clustername
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            isCreated=false
            isFailed=false
            counter=0
            while [[ $isCreated != true && $isFailed == false ]];
            do
              atlas backups snapshots describe {{ .Phases.mongoBackup.Output.snapshotId }}\
              --clusterName ${MONGODB_ATLAS_CLUSTER_NAME} -o json > output.json
              isCompleted=$(jq -r ".status" output.json)
              if [ $isCompleted == "failed" ]; then
                exit 1
              fi
              if [ $isCompleted == "completed" ]; then
                exit 0
              fi
              sleep 30
              if [[ $counter -ge 40 ]]; then
                echo "Timed out waiting for backup completion."
                exit 1
              fi
              counter=$((counter+1))
            done

  restore:
    inputArtifactNames:
      - backupOutput
    phases:
    - func: KubeTask
      name: mongoRestore
      args:
        namespace: "{{ .Object.metadata.namespace }}"
        image: <registry>/<repository>/mongodb-atlas:<tag_name>
        podOverride:
          containers:
          - name: container
            env:
            - name: MONGODB_ATLAS_PUBLIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: publickey
            - name: MONGODB_ATLAS_PRIVATE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: privatekey
            - name: MONGODB_ATLAS_ORG_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: orgid
            - name: MONGODB_ATLAS_PROJECT_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: projectid
            - name: MONGODB_ATLAS_CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: clustername
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            snapshot_id='{{ .ArtifactsIn.backupOutput.KeyValue.snapshotId }}'
            target_cluster_name=${MONGODB_ATLAS_CLUSTER_NAME}
            target_project_id='{{ .Object.data.projectid | toString | b64dec }}'
            atlas backup restore start automated --clusterName ${MONGODB_ATLAS_CLUSTER_NAME} --snapshotId ${snapshot_id} \
            --targetClusterName ${target_cluster_name} --targetProjectId ${target_project_id} -o json > output.json
            restore_id=$(jq -r ".id" output.json)
            kando output restoreId ${restore_id}

    - func: KubeTask
      name: waitForRestoreToComplete
      args:
        namespace: "{{ .Object.metadata.namespace }}"
        image: <registry>/<repository>/mongodb-atlas:<tag_name>
        podOverride:
          containers:
          - name: container
            env:
            - name: MONGODB_ATLAS_PUBLIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: publickey
            - name: MONGODB_ATLAS_PRIVATE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: privatekey
            - name: MONGODB_ATLAS_ORG_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: orgid
            - name: MONGODB_ATLAS_PROJECT_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: projectid
            - name: MONGODB_ATLAS_CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: clustername
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            isCreated=false
            isFailed=false
            counter=0
            while [[ $isCreated != true && $isFailed == false ]];
            do
              atlas backups restores describe {{ .Phases.mongoRestore.Output.restoreId }}\
              --clusterName ${MONGODB_ATLAS_CLUSTER_NAME} -o json > output.json
              isFinished=$(jq -r ".finishedAt" output.json)
              isRestoreFailed=$(jq -r ".failed" output.json)
              if [ $isRestoreFailed == "true" ]; then
                exit 1
              fi
              if [ $isRestoreFailed == "false" ] && [ $isFinished != "null" ]; then
                exit 0
              fi
              sleep 30
              if [[ $counter -ge 40 ]]; then
                echo "Timed out waiting for restore completion."
                exit 1
              fi
              counter=$((counter+1))
            done

  delete:
    inputArtifactNames:
      - backupOutput
    phases:
    - func: KubeTask
      name: deleteMongoBackup
      args:
        namespace: "{{ .Namespace.Name }}"
        image: <registry>/<repository>/mongodb-atlas:<tag_name>
        podOverride:
          containers:
          - name: container
            env:
            - name: MONGODB_ATLAS_PUBLIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: publickey
            - name: MONGODB_ATLAS_PRIVATE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: privatekey
            - name: MONGODB_ATLAS_ORG_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: orgid
            - name: MONGODB_ATLAS_PROJECT_ID
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: projectid
            - name: MONGODB_ATLAS_CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: mongo-atlas-secret
                  key: clustername
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            atlas backups snapshots delete {{ .ArtifactsIn.backupOutput.KeyValue.snapshotId }} \
            --clusterName ${MONGODB_ATLAS_CLUSTER_NAME} --force
